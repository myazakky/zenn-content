---
title: "Effã§Algebraic Effectsã«è§¦ã‚Œã¦ã¿ã‚ˆã†"
emoji: "ğŸ¦‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Eff", "AlgebraicEffects", "å‹ã‚·ã‚¹ãƒ†ãƒ "]
published: true
---


Algebraic Effectsã«ã¤ã„ã¦èª¿ã¹ã¦ã„ã¦ï¼Œãã‚Œã«é–¢ã™ã‚‹æ—¥æœ¬èªè¨˜äº‹ãŒå°‘ãªã‹ã£ãŸã‚ˆã†ãªã®ã§æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸï¼
é–“é•ã£ãŸã“ã¨ãŒæ›¸ã„ã¦ã‚ã£ãŸå ´åˆIssueã‚„PRç­‰ã§æŒ‡æ‘˜ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼ã¾ãŸï¼Œç†è§£ãŒé›£ã—ã„è¨˜è¿°ã‚„ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã£ãŸå ´åˆã¯è³ªå•ã—ã¦ã»ã—ã„ã§ã™ï¼

## æ¦‚è¦
Algebraic Effects ã¯ æ—¥æœ¬èªã«è¨³ã™ã¨ä»£æ•°çš„åŠ¹æœã¨ãªã‚Šã¾ã™ï¼ã“ã®Effectsã¨ã„ã†ã®ã¯ï¼Œå‰¯ä½œç”¨ã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ï¼
ä»£æ•°çš„å‰¯ä½œç”¨ã¨è¨³ã—ãŸã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ï¼æœ€è¿‘å··ã§æµè¡Œã‚Šå§‹ã‚ã¦ã¾ã™ï¼

Algebraic Effectsã§è¿½åŠ ã•ã‚Œã‚‹æ©Ÿèƒ½ã¯ï¼ŒEffects & Handler ã§ã™ï¼ã“ã®2ã¤ã•ãˆã‚ã‚Œã°ï¼Œ`return`, `yeild`, `async/await`, `try-catch` ãªã©ã®å‰¯ä½œç”¨ãŒã‚ã‚‹æ©Ÿèƒ½ã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã®ã§ã™ï¼ã“ã‚Œã‚‰ã¯ã»ã¨ã‚“ã©ã®è¨€èªã§ã¯ï¼Œç‰¹æ®Šãªæ©Ÿèƒ½ã¨ã—ã¦å­˜åœ¨ã—ã¦ã„ã¾ã™ã‚ˆã­ï¼ãã‚Œã‚‰ã‚’Effects & Handler ã ã‘ã§è¡¨ã™ã“ã¨ãŒã§ãã‚‹ã®ã§ï¼ŒEffects & Handlerã¯éå¸¸ã«å¼·åŠ›ã§ã™ï¼ãã—ã¦ï¼ŒEffects & Handler ã¯å‹å®‰å…¨ã§ã™[^1] [^2]ï¼

Haskellãªã©ã®é–¢æ•°å‹è¨€èªã§ã¯ï¼Œå‰¯ä½œç”¨ã‚’ä¼´ã†æ“ä½œã¯é€šå¸¸ãƒ¢ãƒŠãƒ‰ã‚’ä½¿ã£ã¦å‹ä»˜ã‘ã‚’ã—ã¾ã™ï¼
ã—ã‹ã—ï¼Œãã‚Œã¯è¤‡é›‘ã§ï¼Œè¤‡æ•°ã®å‰¯ä½œç”¨ãŒçµ¡ã‚€å‡¦ç†ã«ã¯ãƒ¢ãƒŠãƒ‰å¤‰æ›å­ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ãã—ã¦ãã‚Œã¯å°‘ã—é¢å€’è‡­ã„ã§ã™ï¼åƒ•ã¯Haskellã‚„ãƒ¢ãƒŠãƒ‰ã«ã¤ã„ã¦æ˜ã‚‹ããªã„ã®ã§ï¼Œè©³ã—ã„ã“ã¨ã¯[ã³ã—ã‚‡ã€œã˜ã‚‡ã•ã‚“ã®è¨˜äº‹ https://nymphium.github.io/2020/03/15/ae-ee.html]ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼
ã—ã‹ã—ï¼ŒAlgebraic Effectsã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã£ã¦ï¼Œãƒ¢ãƒŠãƒ‰ã‚ˆã‚Šç°¡æ½”ã«å‰¯ä½œç”¨ã®çµåˆã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™[^3]ï¼

ã¾ã‚é›£ã—ã„èª¬æ˜ã¯ç½®ã„ã¦ãŠã„ã¦ï¼Œå®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## Effã«ã¤ã„ã¦
Effã¯Algebraic Effectsã‚’å®Ÿè£…ã—ãŸå®Ÿé¨“çš„ãªè¨€èªã§ã™ï¼ã“ã®è¨€èªã«é–¢ã™ã‚‹è«–æ–‡[^4]ãŒèµ·çˆ†å‰¤ã¨ãªã‚ŠAlgebraic EffectsãŒæµè¡Œã£ãŸãã†ã§ã™[^5]ï¼ä»Šå›ã¯ã“ã‚Œã‚’ä½¿ã£ã¦èª¬æ˜ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼

## Eff ã®å®Ÿè¡Œæ–¹æ³•
webã§å®Ÿè¡Œã™ã‚‹(ç°¡å˜ã ã‹ã‚‰ãŠã™ã™ã‚)
https://www.eff-lang.org/try/

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å‹•ã‹ã™
https://github.com/matijapretnar/eff

## yieldã®å®Ÿè£…
```ocaml
effect Yield: int -> unit

let iter_handler action = handler
  | effect (Yield x) k -> action(x); k ()
;;
 
let for_each iter_func action =
  with iter_handler action handle
  iter_func(3)
;;

let iter_func x =
  perform (Yield x - 1);
  perform (Yield x - 2);
  perform (Yield x - 3);
  ()
;;

let action x = print(x);;

for_each iter_func action
;;
```

```
 val iter_handler : (int -> 'a) -> unit => unit = <fun>
 val for_each : (int -> unit) -> (int -> 'a) -> unit = <fun>
 val iter_func : int -> unit = <fun>
 val action : 'a -> unit = <fun>
 2
 1
 0
 - : unit = ()
```

`iter_func`ã§`Yield`ã‚’å‘¼ã¶ãŸã³ã«ï¼Œæ•°å­—ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™
ã“ã®ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼

### Effectã®å®šç¾©
```ocaml
effect Yield: int -> unit
```
`effect-type`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼
ã“ã“ã§ã¯ï¼Œ`Yield`ã¯`int`ã‚’å—ã‘å–ã£ã¦`unit`ã‚’è¿”ã™å‰¯ä½œç”¨ã®ã‚ã‚‹é–¢æ•°ã¨ã„ã†å®šç¾©ã‚’ã—ã¦ã„ã¾ã™ï¼
ã“ã“ã§ã¯ï¼Œå‹ã‚’å®šç¾©ã™ã‚‹ã ã‘ã§ï¼Œå®Ÿéš›ã«ã©ã†ã„ã£ãŸå€¤ã‚‚ã—ãã¯å‡¦ç†ã‚’æŒã¤ã‹ã¯ï¼Œåˆ¥ã®ã¨ã“ã‚ã§æ±ºã‚ã¾ã™ï¼
åˆ¥ã®ã¨ã“ã‚ã¨ã„ã†ã®ã¯ï¼Œ`handler`ã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ï¼
ã¤ã¾ã‚Šï¼Œå½¢å¼çš„ãªå®šç¾©ã¨å‡¦ç†ã®å®šç¾©ã¯åˆ¥ã€…ã«ã—ã¦ã„ã‚‹ã®ã§ã™ï¼

### Handlerã®å®šç¾©
```ocaml
let iter_handler action = handler
  | effect (Yield x) k -> action(x); k ()
;;
```
`handler`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ï¼æ­£ç¢ºã«ã„ã†ã¨ï¼Œ`action`ã¨ã„ã†å¼•æ•°ã‚’å–ã£ã¦ï¼Œ`handler`ã‚’è¿”ã™é–¢æ•°ã§ã™ï¼
`| effect (F x) k -> ...` ã§ï¼Œå‰¯ä½œç”¨ã®ã‚ã‚‹é–¢æ•°`F` ãŒå‘¼ã°ã‚ŒãŸæ™‚ã«ã™ã‚‹å‡¦ç†ã‚’(`...`ã®éƒ¨åˆ†ã«)æ›¸ãã¾ã™ï¼
`k` ã¨ã„ã†ã®ã¯ç¶™ç¶šã§ã™ï¼

`Yield`ã®å ´åˆã¯ï¼Œä»»æ„ã®é–¢æ•°`action`ã«`x`ã‚’æ¸¡ã—ã¦ï¼Œãã®å¾Œã®å‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹ã¨è¨€ã†å‡¦ç†ã«ãªã£ã¦ã„ã¾ã™ï¼

#### ç¶™ç¶šã«ã¤ã„ã¦
ç¶™ç¶šã¨ã„ã†ã®ã¯ï¼Œã“ã®å ´åˆ`Yeild`ãŒå‘¼ã°ã‚ŒãŸå¾Œã®å‡¦ç†ã‚’æŒ‡ã—ã¦ã„ã¾ã™ï¼
ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆ
```ocaml
perform (Yield 10);
print("hello")
```
kã«ã¯æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ãŒå…¥ã‚‹ã¨è€ƒãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™(å®Ÿéš›ã«ã¯é–¢æ•°ã¨ã¯é•ã†ã®ã§æ³¨æ„ï¼Œã‚ãã¾ã§ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™)ï¼
```ocaml
let k x =
  x;
  print("hello")
```
ç¶™ç¶šã«ã¤ã„ã¦ã®è©³ã—ãè§£èª¬ã—ã¦ã„ã‚‹è¨˜äº‹ã‚’è²¼ã£ã¦ãŠãã¾ã™ï¼è©³ã—ãã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ï¼
- https://practical-scheme.net/wiliki/wiliki.cgi?Scheme%3Aä½¿ã„ãŸã„äººã®ãŸã‚ã®ç¶™ç¶šå…¥é–€
- http://practical-scheme.net/docs/cont-j.html

### Effects & Handler

```ocaml
let for_each iter_func action =
  with iter_handler action handle
  iter_func(3)
;;
```
æ³¨ç›®ã™ã‚‹ã¹ãã¯ `with iter_handler action handle ...` ã®éƒ¨åˆ†ã§ã™ï¼

`with H handle ...` ã¨ã„ã†æ§‹æ–‡ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ï¼
`...`ã¯å‰¯ä½œç”¨ãŒç™ºç”Ÿã—å¾—ã‚‹å‡¦ç†ã§ã™ï¼å‰¯ä½œç”¨ãŒç™ºç”Ÿã—ãŸå ´åˆï¼Œ`H`ã«å®šç¾©ã•ã‚Œã‚‹å‡¦ç†ã«å¾“ã£ã¦ï¼Œå‰¯ä½œç”¨ã‚’å‡¦ç†ã—ã¾ã™ï¼

ã“ã®ã‚³ãƒ¼ãƒ‰ã§è¨€ã†ã¨ï¼Œ`H`ã¯`(iter_handler action)` ã« `...`ã¯`iter_func(3)`ã¨ãªã‚Šã¾ã™ï¼
`iter_func(3)`ã®ä¸­ã§ï¼Œ`Yield`ã¨è¨€ã†å‰¯ä½œç”¨ãŒã§ãŸå ´åˆã¯ï¼Œ`iter_handle action`ã®` effect (Yield x) k -> action(x); k ()`ãŒç™ºç«ã™ã‚‹ã¨è¨€ã†æ„Ÿã˜ã§ã™ï¼

### ã©ã®ã‚ˆã†ã«å‹•ãã‹

ã“ã“ã¾ã§ã¯ï¼Œå®šç¾©ã«ã¤ã„ã¦è¦‹ã¦ã¿ã¾ã—ãŸãŒï¼Œå®Ÿéš›ã«ãã‚Œã‚‰ã‚’ä½¿ç”¨ã—ã¦ãã®å‹•ãã‚’è¿½ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼

```ocaml
let iter_func x =
  perform (Yield x - 1);
  perform (Yield x - 2);
  perform (Yield x - 3);
  ()
;;
 
let action x = print(x);;
 
for_each iter_func action
```

ã“ã‚Œã‚’rubyã§æ›¸ãã¨ã“ã†ãªã‚‹ã¨æ€ã„ã¾ã™ï¼
```ruby
def iter_func(x)
  yield x - 1
  yield x - 2
  yield x - 3
end

iter_func(3) { |x| puts x }
```

ã¾ãšï¼Œ`action(3)`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼
`perform (Yield 3 - 1)` ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
`effect (Yield 3) k -> action(3); k ()` ã§ãã‚ŒãŒãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™
`action(2)`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼
`print(2)`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼
`k ()`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼
`perform (Yield x - 2)`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼
ãã‚ŒãŒç¶šã

ã¨è¨€ã†æ„Ÿã˜ã§ã™ï¼

Algebraic Effectsã®æ©Ÿèƒ½ Effects & Handlerã«ã‚ˆã£ã¦`Yield`ãŒå®Ÿè£…ã§ãã¾ã—ãŸï¼
ä»–ã«ã‚‚ï¼Œ`raise`, `state`, `try-catch`, `async/await` ãªã©ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

### ã¾ã¨ã‚
ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã¾ã‚ã‹ãªã‚Šé›‘ãªè¨˜äº‹ã§ã™ï¼ãã‚Œã§ã‚‚Algebraic Effects ã«ã¤ã„ã¦å°‘ã—ã§ã‚‚èˆˆå‘³ã‚’æŒã£ãŸã®ãªã‚‰ã°å¹¸ã„ã§ã™ï¼
èˆˆå‘³ã‚’æŒãŸã‚ŒãŸã®ã§ã‚ã‚Œã°ï¼Œhttps://www.eff-lang.org ã«ã‚‚ã£ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒè¼‰ã£ã¦ã‚ã‚‹ã®ã§ï¼Œãœã²è¦‹ã¦ãã ã•ã„ï¼
Rubyã‚„Pythonãªã©ã®è‰²ã€…ãªè¨€èªã§ï¼ŒAlgebraic Effectsã‚’å®Ÿè£…ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã®ã§ãã‚Œã‚‰ã‚’ä½¿ã£ã¦ã¿ã‚‹ã®ã‚‚ã‚ã‚Šã§ã™ï¼
é–¢é€£ãƒªãƒ³ã‚¯é›†ã‚’è¼‰ã›ã¾ã—ãŸã®ã§ï¼Œãœã²ãã¡ã‚‰ã‚‚è¦‹ã¦ã¿ã¦ãã ã•ã„ï¼

#### é–¢é€£ãƒªãƒ³ã‚¯é›†
https://scrapbox.io/myazakky/Effã§Algebraic_Effectsã«è§¦ã‚Œã¦ã¿ã‚ˆã†
https://nymphium.github.io/tags.html
https://medium.com/@kuy/algebraic-effects-è‡ªç¿’ç”¨è³‡æ–™ã¾ã¨ã‚-e589fa74607d
https://github.com/yallop/effects-bibliography
https://misreading.chat/2019/06/23/episode-63-programming-with-algebraic-effects-and-handlers/
https://www.microsoft.com/en-us/research/wp-content/uploads/2016/08/algeff-tr-2016-v2.pdf
https://overreacted.io/ja/algebraic-effects-for-the-rest-of-us/

[^1]: An Introduction to Algebraic Effects and Handlers, Theorem 4.2 
URL: https://www.eff-lang.org/handlers-tutorial.pdf
[^2]: polymophic effectsã‚’å°å…¥ã—ãŸå ´åˆï¼Œå‹å®‰å…¨ã§ãªããªã‚‹ã“ã¨ãŒä¸€èˆ¬ã«çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ï¼
[^3]: Programming with Algebraic Effects and Handlers, Introduce
URL: https://arxiv.org/pdf/1203.1539.pdf
[^4]: Programming with Algebraic Effects and Handlers
URL: https://arxiv.org/pdf/1203.1539.pdf
[^5]: https://misreading.chat/2019/06/23/episode-63-programming-with-algebraic-effects-and-handlers/ ã®ã©ã“ã‹ã§ãã‚“ãªè©±ã‚’ã—ã¦ã„ã‚‹
